<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>üíï LinLove</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #020617; --glass: rgba(15, 23, 42, 0.72); --glass-soft: rgba(15, 23, 42, 0.52);
            --accent: #ff4b8b; --accent-soft: rgba(255, 75, 139, 0.16); --success: #4ade80; --danger: #fb7185;
            --text: #f9fafb; --text-muted: #9ca3af; --border-subtle: rgba(148, 163, 184, 0.18);
            --shadow-strong: 0 18px 55px rgba(15, 23, 42, 0.85); --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.65);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
            background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000 100%);
            color: var(--text); min-height: 100vh; padding-bottom: env(safe-area-inset-bottom);
            -webkit-font-smoothing: antialiased; overscroll-behavior: none;
        }
        .hidden { display: none !important; }

        /* Setup Screen (First Launch) */
        .setup-screen {
            position: fixed; inset: 0; z-index: 200; background: var(--bg);
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
            padding-bottom: 50px;
        }
        .setup-content {
            background: var(--glass); border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 24px; padding: 24px; margin-top: 20px;
            backdrop-filter: blur(20px);
        }

        /* Main App Shell */
        .app-shell {
            position: fixed; inset: 0; display: flex; flex-direction: column;
            padding: 12px 12px calc(12px + env(safe-area-inset-bottom)); gap: 12px;
            max-width: 540px; margin: 0 auto; z-index: 10;
        }

        /* Top Bar */
        .glass-panel {
            border-radius: 28px;
            background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.16), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.16), transparent 55%), var(--glass);
            border: 1px solid rgba(148, 163, 184, 0.34); box-shadow: var(--shadow-strong);
            backdrop-filter: blur(26px) saturate(180%); -webkit-backdrop-filter: blur(26px) saturate(180%);
            flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .top-bar { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px 10px; gap: 10px; flex-shrink: 0; }
        .top-title { display: flex; align-items: center; gap: 10px; }
        .top-logo {
            width: 30px; height: 30px; border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #f97316, transparent 55%),
                        radial-gradient(circle at 70% 80%, #f43f5e, transparent 60%), #0f172a;
            display: flex; align-items: center; justify-content: center; font-size: 17px;
            box-shadow: 0 8px 26px rgba(248, 113, 113, 0.75);
        }
        .top-text-main { font-size: 16px; font-weight: 600; letter-spacing: 0.02em; }
        .top-text-sub { font-size: 12px; color: var(--text-muted); }
        .action-icon-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: all 0.2s; color: var(--text); }
        .action-icon-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Filters Panel */
        .filters-panel {
            background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            padding: 16px; display: none; flex-direction: column; gap: 12px;
        }
        .filters-panel.visible { display: flex; }
        .filter-row { display: flex; gap: 12px; }
        .filter-input { flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(148, 163, 184, 0.3);
            color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; }

        /* Main Content Area */
        .screen-container { flex: 1; position: relative; overflow: hidden; }

        /* Feed Card 9:16 */
        .feed-frame {
            width: 100%; height: 100%; position: relative; overflow: hidden;
        }
        .feed-photo-layer { position: absolute; inset: 0; overflow: hidden; }
        .feed-photo { width: 100%; height: 100%; object-fit: cover; transform: scale(1.04); }
        .feed-gradient-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, transparent 30%, transparent 60%, rgba(0,0,0,0.95) 100%); pointer-events: none; }
        
        .feed-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; padding-bottom: 80px; pointer-events: none; }
        .feed-name { font-size: 28px; font-weight: 800; margin-bottom: 6px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .feed-location { font-size: 14px; opacity: 0.9; margin-bottom: 12px; display: flex; align-items: center; gap: 4px; }
        .feed-bio { font-size: 15px; line-height: 1.4; opacity: 0.9; margin-bottom: 12px; max-width: 90%; }
        .feed-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .feed-tag { background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }

        /* Floating Action Buttons */
        .actions-float {
            position: absolute; bottom: 20px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 30px; pointer-events: auto;
        }
        .circle-btn {
            width: 64px; height: 64px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center; font-size: 28px;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .circle-btn:active { transform: scale(0.9); }
        .btn-dislike { background: #1e293b; color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); }
        .btn-like { background: linear-gradient(135deg, #ff4b8b, #ff8a80); color: white; border: none; box-shadow: 0 10px 30px rgba(255, 75, 139, 0.4); }

        /* Bottom Nav */
        .bottom-nav-glass { margin-top: auto; padding: 8px 12px; position: relative; z-index: 100; pointer-events: auto; }
        .bottom-nav-inner {
            border-radius: 22px; background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(148, 163, 184, 0.2);
            display: flex; align-items: center; justify-content: space-between; padding: 6px 10px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .nav-toggle { background: rgba(0,0,0,0.3); border-radius: 20px; padding: 3px; display: flex; }
        .nav-item { padding: 6px 14px; border-radius: 16px; font-size: 12px; color: #9ca3af; cursor: pointer; display: flex; align-items: center; gap: 6px; pointer-events: auto; }
        .nav-item.active { background: rgba(255, 75, 139, 0.2); color: white; }
        .nav-icons { display: flex; gap: 12px; }
        .nav-icon { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #cbd5e1; cursor: pointer; position: relative; pointer-events: auto; }
        .nav-icon.active { background: rgba(255,255,255,0.1); color: white; }
        .badge { position: absolute; top: 0; right: 0; width: 14px; height: 14px; background: #ff4b8b; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; color: white; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #cbd5e1; }
        .form-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(0,0,0,0.3); color: white; font-size: 16px; }
        .form-textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(0,0,0,0.3); color: white; font-size: 16px; min-height: 100px; resize: vertical; }
        .photo-picker { width: 120px; height: 120px; border-radius: 24px; background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2); margin: 0 auto 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
        .photo-picker img { width: 100%; height: 100%; object-fit: cover; }
        .btn-primary { width: 100%; padding: 14px; border-radius: 14px; border: none; background: linear-gradient(135deg, #ff4b8b, #ff8a80); color: white; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: white; font-size: 14px; cursor: pointer; margin-top: 8px; }
        .btn-danger { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255, 59, 48, 0.3); background: rgba(255, 59, 48, 0.1); color: #ff3b30; font-size: 14px; cursor: pointer; margin-top: 24px; }

        /* Likes & Chats Lists */
        .list-container { padding: 16px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; height: 100%; }
        .list-item { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
        .list-item:active { background: rgba(255,255,255,0.1); }
        .list-avatar { width: 50px; height: 50px; border-radius: 14px; background: #334155; object-fit: cover; }
        .list-info { flex: 1; }
        .list-title { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
        .list-sub { font-size: 13px; color: #94a3b8; }
        .list-actions { display: flex; gap: 8px; }
        .mini-btn { padding: 6px 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-accept { background: #4ade80; color: #022c22; }
        .btn-reject { background: #fca5a5; color: #450a0a; }

        /* Chat Detail */
        .chat-view { display: flex; flex-direction: column; height: 100%; }
        .chat-header { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .chat-back { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 4px; }
        .messages-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        .message-bubble { padding: 10px 14px; border-radius: 14px; max-width: 80%; font-size: 15px; line-height: 1.4; }
        .msg-own { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: rgba(255,255,255,0.1); color: white; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 12px; background: rgba(0,0,0,0.3); display: flex; gap: 8px; }
        .chat-input { flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 10px 14px; border-radius: 20px; color: white; }
        .chat-send { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Empty State */
        .empty-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8; text-align: center; padding: 20px; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>

<!-- SETUP SCREEN (Visible ONLY if no profile) -->
<div id="setup-screen" class="setup-screen hidden">
    <h1 style="text-align: center; font-size: 28px; margin-top: 20px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üíï</h1>
    <p style="text-align: center; color: var(--text-muted); font-size: 14px;">–°–æ–∑–¥–∞–π –∞–Ω–∫–µ—Ç—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</p>
    
    <div class="setup-content">
        <div class="photo-picker" onclick="document.getElementById('setup-photo').click()">
            <img id="preview-photo" style="display: none;" />
            <div id="placeholder-photo" style="text-align: center;">
                <span style="font-size: 24px;">üì∏</span>
                <span style="font-size: 11px; display: block;">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
            </div>
        </div>
        <input type="file" id="setup-photo" accept="image/*" style="display: none;" />
        
        <div class="form-group">
            <label class="form-label">–ò–º—è</label>
            <input type="text" id="input-name" class="form-input" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" />
        </div>
        <div class="form-group" style="display: flex; gap: 12px;">
            <div style="flex: 1;">
                <label class="form-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                <input type="number" id="input-age" class="form-input" placeholder="18+" />
            </div>
            <div style="flex: 2;">
                <label class="form-label">–ì–æ—Ä–æ–¥</label>
                <input type="text" id="input-city" class="form-input" placeholder="–ì–¥–µ —Ç—ã?" />
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">–û —Å–µ–±–µ</label>
            <textarea id="input-bio" class="form-textarea" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ..."></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">–ò–Ω—Ç–µ—Ä–µ—Å—ã</label>
            <div id="setup-tags" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>
        
        <button class="btn-primary" onclick="createProfile()">–°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É</button>
    </div>
</div>

<!-- MAIN APP (Visible ONLY after profile creation) -->
<div id="main-app" class="app-shell hidden">
    <div class="glass-panel">
        <!-- Top Header -->
        <div class="top-bar">
            <div class="top-title">
                <div class="top-logo"><span>üíï</span></div>
                <div>
                    <div class="top-text-main">LinLove</div>
                    <div class="top-text-sub" id="status-text">–ø–æ–∏—Å–∫ –ø–∞—Ä—ã</div>
                </div>
            </div>
            <button id="filter-btn" class="action-icon-btn hidden" onclick="toggleFilters()">‚ö°Ô∏è</button>
        </div>

        <!-- Filters (Expandable) -->
        <div id="filters-panel" class="filters-panel">
            <div class="filter-row">
                <input type="number" id="filter-age-min" class="filter-input" placeholder="–û—Ç –ª–µ—Ç" />
                <input type="number" id="filter-age-max" class="filter-input" placeholder="–î–æ –ª–µ—Ç" />
            </div>
            <input type="text" id="filter-city" class="filter-input" placeholder="–ì–æ—Ä–æ–¥..." />
            <button class="btn-primary" style="margin-top: 0; padding: 8px;" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <!-- CONTENT AREA -->
        <div class="screen-container">
            
            <!-- 1. FEED -->
            <div id="view-feed" class="feed-frame">
                <!-- Inner content injected dynamically to prevent artifacts -->
            </div>

            <!-- 2. LIKES -->
            <div id="view-likes" class="list-container hidden"></div>
            <div id="likes-empty" class="empty-view hidden">
                <div class="empty-icon">üíî</div>
                <div>–ü–æ–∫–∞ –Ω–µ—Ç –ª–∞–π–∫–æ–≤</div>
            </div>

            <!-- 3. CHATS -->
            <div id="view-chats" class="list-container hidden"></div>
            <div id="chats-empty" class="empty-view hidden">
                <div class="empty-icon">üì¨</div>
                <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>
            </div>

            <!-- 4. PROFILE -->
            <div id="view-profile" class="list-container hidden">
                <div style="text-align: center; margin-top: 20px;">
                    <img id="my-photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent);" />
                    <h2 id="my-name" style="margin-top: 10px; font-size: 24px;"></h2>
                    <p id="my-bio" style="color: #94a3b8; margin-top: 6px; font-size: 14px; padding: 0 20px;"></p>
                </div>
                <div style="margin-top: 30px; padding: 0 20px;">
                    <button class="btn-secondary" onclick="startEditProfile()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="btn-danger" onclick="deleteProfile()">üóë –£–¥–∞–ª–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
                </div>
            </div>

            <!-- 5. CHAT ROOM -->
            <div id="view-chat-room" class="chat-view hidden">
                <div class="chat-header">
                    <button class="chat-back" onclick="closeChat()">‚Üê</button>
                    <img id="room-avatar" style="width: 32px; height: 32px; border-radius: 50%;" />
                    <span id="room-name" style="font-weight: 600;"></span>
                </div>
                <div id="room-messages" class="messages-area"></div>
                <div class="chat-input-area">
                    <input type="text" id="room-input" class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
                    <button class="chat-send" onclick="sendMsg()">‚û§</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottom-nav" class="bottom-nav-glass">
        <div class="bottom-nav-inner">
            <div class="nav-toggle">
                <div class="nav-item active" onclick="switchTab('feed')" id="tab-feed">–ê–Ω–∫–µ—Ç—ã</div>
                <div class="nav-item" onclick="switchTab('likes')" id="tab-likes">–õ–∞–π–∫–∏</div>
            </div>
            <div class="nav-icons">
                <div class="nav-icon" onclick="switchTab('chats')" id="tab-chats">
                    üí¨ <div id="badge-chats" class="badge hidden">0</div>
                </div>
                <div class="nav-icon" onclick="switchTab('profile')" id="tab-profile">üë§</div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = window.location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    let user = null;
    let profiles = [];
    let currentProfileIdx = 0;
    let activeTab = 'feed';
    let editMode = false;
    let currentChatUser = null;

    // --- INIT ---
    async function init() {
        if (tg) {
            tg.expand();
            tg.ready();
            tg.disableVerticalSwipes();
        }
        
        const tgUser = tg?.initDataUnsafe?.user;
        if (!tgUser) return; // Not in TG

        // Try load user
        try {
            const res = await fetch(`${API_BASE}/user/${tgUser.id}`);
            if (res.ok) {
                user = await res.json();
                if(user && user.name) {
                    showApp();
                } else {
                    showSetup();
                }
            } else {
                showSetup();
            }
        } catch (e) {
            showSetup();
        }

        loadTags();
    }
    
    // --- NAVIGATION ---
    window.showSetup = function() {
        document.getElementById('setup-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }

    window.showApp = function() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        switchTab('feed');
    }

    window.switchTab = function(tab) {
        try {
            activeTab = tab;
            
            // UI Toggles
            document.querySelectorAll('.nav-item, .nav-icon').forEach(el => el.classList.remove('active'));
            if(tab === 'feed') document.getElementById('tab-feed')?.classList.add('active');
            if(tab === 'likes') document.getElementById('tab-likes')?.classList.add('active');
            if(tab === 'chats') document.getElementById('tab-chats')?.classList.add('active');
            if(tab === 'profile') document.getElementById('tab-profile')?.classList.add('active');

            // HIDE ALL VIEWS
            const allViews = [
                'view-feed', 'view-likes', 'likes-empty',
                'view-chats', 'chats-empty', 'view-profile', 'view-chat-room'
            ];
            allViews.forEach(id => document.getElementById(id)?.classList.add('hidden'));

            // Show base containers
            if(tab === 'feed') {
                document.getElementById('view-feed').classList.remove('hidden');
                document.getElementById('filter-btn').classList.remove('hidden');
                loadFeed();
            } else {
                document.getElementById('filter-btn').classList.add('hidden');
                document.getElementById('filters-panel').classList.remove('visible');
            }

            if(tab === 'likes') {
                document.getElementById('view-likes').classList.remove('hidden');
                loadLikes();
            }

            if(tab === 'chats') {
                document.getElementById('view-chats').classList.remove('hidden');
                loadChats();
            }

            if(tab === 'profile') {
                document.getElementById('view-profile').classList.remove('hidden');
                renderProfileSelf();
            }
        } catch (e) {
            console.error("Tab switch error:", e);
        }
    }

    // --- FEED ---
    window.loadFeed = async function() {
        const ageMin = document.getElementById('filter-age-min').value || 18;
        const ageMax = document.getElementById('filter-age-max').value || 99;
        const city = document.getElementById('filter-city').value || '';
        
        if (!user || !user.id) return;

        const q = new URLSearchParams({ age_min: ageMin, age_max: ageMax, city });
        try {
            profiles = await fetch(`${API_BASE}/profiles/${user.id}?${q}`).then(r => r.json());
            currentProfileIdx = 0;
            renderCard();
        } catch(e) { console.error(e); }
    }

    window.renderCard = function() {
        const viewFeed = document.getElementById('view-feed');
        
        if (!profiles[currentProfileIdx]) {
            // Render Empty State via HTML to avoid artifacts
            viewFeed.innerHTML = `
                <div class="empty-view">
                    <div class="empty-icon">üåç</div>
                    <div>–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</div>
                    <div style="font-size: 12px; margin-top: 8px;">–ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</div>
                </div>
            `;
            return;
        }

        const p = profiles[currentProfileIdx];
        const tagsHtml = p.tags.map(t => `<span class="feed-tag">${t.emoji} ${t.name}</span>`).join('');
        
        // Render Card via HTML
        viewFeed.innerHTML = `
            <div class="feed-frame">
                <div class="feed-photo-layer">
                    <img class="feed-photo" src="${p.photo_url}" />
                    <div class="feed-gradient-overlay"></div>
                </div>
                <div class="feed-content">
                    <div class="feed-name">${p.name}, ${p.age}</div>
                    <div class="feed-location">üìç ${p.city}</div>
                    <div class="feed-bio">${p.bio || ''}</div>
                    <div class="feed-tags">${tagsHtml}</div>
                </div>
                <div class="actions-float">
                    <button class="circle-btn btn-dislike" onclick="swipe(false)">‚úï</button>
                    <button class="circle-btn btn-like" onclick="swipe(true)">‚ô•</button>
                </div>
            </div>
        `;
    }

    window.swipe = async function(isLike) {
        if (tg) tg.HapticFeedback.impactOccurred(isLike ? 'heavy' : 'light');
        const p = profiles[currentProfileIdx];
        if (!p) return;

        currentProfileIdx++;
        renderCard();

        try {
            const res = await fetch(`${API_BASE}/like`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ from_user: user.id, to_user: p.id, dislike: !isLike })
            }).then(r => r.json());
            
            if (res.match) {
                if(tg) tg.HapticFeedback.notificationOccurred('success');
                alert(`–≠—Ç–æ –ú—ç—Ç—á —Å ${p.name}! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç.`);
                openChat(p.id, p.name, p.photo_url);
            }
        } catch(e) {}
    }

    window.toggleFilters = function() {
        document.getElementById('filters-panel').classList.toggle('visible');
    }
    
    window.applyFilters = function() {
        toggleFilters();
        loadFeed();
    }

    // --- PROFILE CREATION / EDIT ---
    let selectedTags = [];
    async function loadTags() {
        try {
            const tags = await fetch(`${API_BASE}/tags`).then(r => r.json());
            const container = document.getElementById('setup-tags');
            container.innerHTML = tags.map(t => 
                `<div class="feed-tag" onclick="toggleTag(${t.id}, this)" style="cursor:pointer; border:1px solid #334155">${t.emoji} ${t.name}</div>`
            ).join('');
        } catch(e) {}
    }

    window.toggleTag = function(id, el) {
        if(selectedTags.includes(id)) {
            selectedTags = selectedTags.filter(x => x !== id);
            el.style.background = 'transparent';
        } else {
            selectedTags.push(id);
            el.style.background = 'var(--accent)';
        }
    }

    document.getElementById('setup-photo').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('preview-photo').src = ev.target.result;
            document.getElementById('preview-photo').style.display = 'block';
            document.getElementById('placeholder-photo').style.display = 'none';
        }
        reader.readAsDataURL(file);
    });

    window.createProfile = async function() {
        const name = document.getElementById('input-name').value;
        const age = document.getElementById('input-age').value;
        const city = document.getElementById('input-city').value;
        const bio = document.getElementById('input-bio').value;
        const file = document.getElementById('setup-photo').files[0];
        
        if (!name || !age || !city) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');

        let photoUrl = user?.photo_url;
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            await new Promise(r => reader.onload = r);
            const base64 = reader.result;
            
            const up = await fetch(`${API_BASE}/upload-photo`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id, photo_data: base64 })
            }).then(r=>r.json());
            photoUrl = up.photo_url;
        }

        const payload = {
            id: tg.initDataUnsafe.user.id,
            name, age: parseInt(age), city, bio,
            photo_url: photoUrl,
            tag_ids: selectedTags
        };

        const res = await fetch(`${API_BASE}/user`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            const newUser = await res.json();
            user = newUser.user || newUser; 
            if (user.id === undefined && newUser.id) user = newUser;
            showApp();
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
        }
    }

    // --- EDIT & DELETE ---
    window.renderProfileSelf = function() {
        try {
            if(!user || !user.name) {
                // Should not happen, but safe fallback
                return showSetup();
            }
            document.getElementById('my-photo').src = user.photo_url || '';
            document.getElementById('my-name').textContent = `${user.name}, ${user.age}`;
            document.getElementById('my-bio').textContent = user.bio || '';
        } catch(e) { console.error(e); }
    }

    window.startEditProfile = function() {
        showSetup();
        if(user) {
            document.getElementById('input-name').value = user.name || '';
            document.getElementById('input-age').value = user.age || '';
            document.getElementById('input-city').value = user.city || '';
            document.getElementById('input-bio').value = user.bio || '';
            if(user.photo_url) {
                document.getElementById('preview-photo').src = user.photo_url;
                document.getElementById('preview-photo').style.display = 'block';
                document.getElementById('placeholder-photo').style.display = 'none';
            }
        }
    }

    window.deleteProfile = async function() {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–Ω–∫–µ—Ç—É?')) return;
        await fetch(`${API_BASE}/user/${user.id}`, { method: 'DELETE' });
        user = null;
        showSetup();
    }

    // --- LIKES ---
    window.loadLikes = async function() {
        if (!user || !user.id) return;
        try {
            const list = await fetch(`${API_BASE}/likes/${user.id}`).then(r => r.json());
            const container = document.getElementById('view-likes');
            const empty = document.getElementById('likes-empty');
            container.innerHTML = '';
            
            if(!list.length) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            container.classList.remove('hidden');

            list.forEach(l => {
                container.innerHTML += `
                <div class="list-item">
                    <img src="${l.photo_url}" class="list-avatar">
                    <div class="list-info">
                        <div class="list-title">${l.name}, ${l.age}</div>
                        <div class="list-sub">${l.city}</div>
                    </div>
                    <div class="list-actions">
                        <button class="mini-btn btn-accept" onclick="replyLike(${l.id}, '${l.name}', '${l.photo_url}')">‚ù§Ô∏è</button>
                        <button class="mini-btn btn-reject" onclick="rejectLike(${l.id})">‚úï</button>
                    </div>
                </div>`;
            });
        } catch(e) {}
    }

    window.replyLike = async function(id, name, photo) {
        await fetch(`${API_BASE}/like`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ from_user: user.id, to_user: id })
        });
        openChat(id, name, photo);
    }
    
    window.rejectLike = async function(id) {
        await fetch(`${API_BASE}/like`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ from_user: user.id, to_user: id, dislike: true })
        });
        loadLikes();
    }

    // --- CHATS ---
    window.loadChats = async function() {
        if (!user || !user.id) return;
        try {
            const chats = await fetch(`${API_BASE}/chats/${user.id}`).then(r => r.json());
            const container = document.getElementById('view-chats');
            const empty = document.getElementById('chats-empty');
            container.innerHTML = '';
            
            if(!chats.length) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            container.classList.remove('hidden');
            document.getElementById('badge-chats').textContent = chats.length;
            document.getElementById('badge-chats').classList.remove('hidden');

            chats.forEach(c => {
                container.innerHTML += `
                <div class="list-item" onclick="openChat(${c.user_id}, '${c.user_name}', '${c.user_photo}')">
                    <img src="${c.user_photo}" class="list-avatar">
                    <div class="list-info">
                        <div class="list-title">${c.user_name}</div>
                        <div class="list-sub">${c.last_message || '–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...'}</div>
                    </div>
                </div>`;
            });
        } catch(e) {}
    }

    // --- CHAT ROOM ---
    window.openChat = function(id, name, photo) {
        currentChatUser = id;
        document.getElementById('view-chats').classList.add('hidden');
        document.getElementById('chats-empty').classList.add('hidden'); // ensure empty is hidden
        document.getElementById('view-chat-room').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.add('hidden');
        
        document.getElementById('room-name').textContent = name;
        document.getElementById('room-avatar').src = photo;
        loadMessages();
    }

    window.closeChat = function() {
        currentChatUser = null;
        document.getElementById('view-chat-room').classList.add('hidden');
        document.getElementById('view-chats').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.remove('hidden');
        loadChats();
    }

    async function loadMessages() {
        if(!currentChatUser || !user || !user.id) return;
        try {
            const msgs = await fetch(`${API_BASE}/messages/${currentChatUser}/${user.id}`).then(r => r.json());
            const area = document.getElementById('room-messages');
            area.innerHTML = msgs.map(m => `
                <div class="message-bubble ${m.from_user == user.id ? 'msg-own' : 'msg-other'}">
                    ${m.text}
                </div>
            `).join('');
            area.scrollTop = area.scrollHeight;
        } catch(e) {}
    }

    window.sendMsg = async function() {
        const txt = document.getElementById('room-input').value;
        if(!txt) return;
        await fetch(`${API_BASE}/message`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ from_user: user.id, to_user: currentChatUser, text: txt })
        });
        document.getElementById('room-input').value = '';
        loadMessages();
    }

    init();
</script>
</body>
</html>