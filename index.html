<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>üíï LinLove</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #020617; --glass: rgba(15, 23, 42, 0.72); --glass-soft: rgba(15, 23, 42, 0.52);
            --accent: #ff4b8b; --accent-soft: rgba(255, 75, 139, 0.16); --success: #4ade80; --danger: #fb7185;
            --text: #f9fafb; --text-muted: #9ca3af; --border-subtle: rgba(148, 163, 184, 0.18);
            --shadow-strong: 0 18px 55px rgba(15, 23, 42, 0.85); --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.65);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
            background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000 100%);
            color: var(--text); min-height: 100vh; padding-bottom: env(safe-area-inset-bottom);
            -webkit-font-smoothing: antialiased; overscroll-behavior: none;
        }
        .app-shell { position: fixed; inset: 0; display: flex; flex-direction: column;
            padding: 12px 12px calc(12px + env(safe-area-inset-bottom)); gap: 12px;
            max-width: 540px; margin: 0 auto;
        }
        .glass-panel {
            border-radius: 28px;
            background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.16), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.16), transparent 55%), var(--glass);
            border: 1px solid rgba(148, 163, 184, 0.34); box-shadow: var(--shadow-strong);
            backdrop-filter: blur(26px) saturate(180%); -webkit-backdrop-filter: blur(26px) saturate(180%);
        }
        .top-bar { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px 10px; gap: 10px; }
        .top-title { display: flex; align-items: center; gap: 10px; }
        .top-logo {
            width: 30px; height: 30px; border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #f97316, transparent 55%),
                        radial-gradient(circle at 70% 80%, #f43f5e, transparent 60%), #0f172a;
            display: flex; align-items: center; justify-content: center; font-size: 17px;
            box-shadow: 0 8px 26px rgba(248, 113, 113, 0.75);
        }
        .top-text-main { font-size: 16px; font-weight: 600; letter-spacing: 0.02em; }
        .top-text-sub { font-size: 12px; color: var(--text-muted); }
        .pill-online { padding: 6px 10px; border-radius: 999px; background: rgba(22, 163, 74, 0.16);
            border: 1px solid rgba(74, 222, 128, 0.5); display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .pill-dot { width: 7px; height: 7px; border-radius: 999px; background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.9); }
        .screen-container { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .feed-frame {
            width: 100%; max-width: 430px; aspect-ratio: 9 / 16; border-radius: 32px; position: relative; overflow: hidden;
            background: radial-gradient(circle at top, rgba(248, 113, 113, 0.24), transparent 55%),
                        radial-gradient(circle at bottom, rgba(37, 99, 235, 0.24), transparent 55%), #020617;
            border: 1px solid rgba(148, 163, 184, 0.45); box-shadow: 0 22px 60px rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(30px) saturate(190%); -webkit-backdrop-filter: blur(30px) saturate(190%);
        }
        .feed-photo-layer { position: absolute; inset: 0; overflow: hidden; }
        .feed-photo { width: 100%; height: 100%; object-fit: cover; transform-origin: center;
            transform: scale(1.04); filter: saturate(1.08) contrast(1.08); }
        .feed-gradient-top { position: absolute; inset: 0 0 65%; 
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.86), transparent 85%); pointer-events: none; }
        .feed-gradient-bottom { position: absolute; inset: 55% 0 0;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.96), transparent 70%); pointer-events: none; }
        .feed-top-meta { position: absolute; inset: 0; padding: 16px 16px 0; display: flex;
            justify-content: space-between; align-items: flex-start; color: #e5e7eb; font-size: 13px; pointer-events: none; }
        .age-pill { padding: 6px 11px; border-radius: 999px; background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.7); display: flex; align-items: center; gap: 6px;
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.8); }
        .age-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--accent); }
        .feed-main-meta { position: absolute; left: 16px; right: 16px; bottom: 120px;
            display: flex; flex-direction: column; gap: 8px; color: #f9fafb; }
        .name-row { display: flex; align-items: baseline; gap: 8px; }
        .name-main { font-size: 22px; font-weight: 700; letter-spacing: 0.01em; }
        .city-tag { padding: 6px 9px; border-radius: 999px; background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.5); font-size: 11px; display: inline-flex;
            align-items: center; gap: 6px; }
        .bio-text { font-size: 13px; color: #e5e7eb; max-width: 90%; text-shadow: 0 10px 35px rgba(15, 23, 42, 0.9); }
        .chips-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 2px; }
        .chip { padding: 5px 9px; border-radius: 999px; background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.65); font-size: 11px; display: inline-flex;
            align-items: center; gap: 4px; }
        .chip-accent { background: rgba(244, 63, 94, 0.18); border-color: rgba(248, 113, 113, 0.85); }
        .actions-row { position: absolute; left: 0; right: 0; bottom: 0;
            padding: 18px 18px calc(18px + env(safe-area-inset-bottom)); display: flex;
            flex-direction: column; gap: 10px; }
        .swipe-hint { display: flex; justify-content: center; font-size: 11px; color: var(--text-muted); gap: 6px; }
        .actions-buttons { display: flex; align-items: center; justify-content: center; gap: 26px; }
        .circle-btn { width: 74px; height: 74px; border-radius: 999px; border: none; outline: none;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: transform 0.16s ease-out, box-shadow 0.16s ease-out, background 0.18s;
            box-shadow: var(--shadow-soft); backdrop-filter: blur(22px) saturate(160%);
            -webkit-backdrop-filter: blur(22px) saturate(160%); }
        .circle-like {
            background: radial-gradient(circle at 30% 20%, #f97316, transparent 55%),
                        radial-gradient(circle at 70% 80%, #f43f5e, transparent 55%), rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(248, 113, 113, 0.85); color: #f9fafb; font-size: 30px;
        }
        .circle-dislike { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.7);
            color: #e5e7eb; font-size: 26px; }
        .circle-btn:active { transform: scale(0.9); box-shadow: 0 6px 18px rgba(15, 23, 42, 0.85); }
        .mini-btn { width: 48px; height: 48px; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center;
            color: #e5e7eb; font-size: 20px; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9); }
        .bottom-nav-glass { margin-top: auto; padding: 8px 12px; }
        .bottom-nav-inner { border-radius: 22px;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.96));
            border: 1px solid rgba(15, 23, 42, 0.9); display: flex; align-items: center;
            justify-content: space-between; padding: 6px 10px; box-shadow: 0 16px 40px rgba(15, 23, 42, 1);
            backdrop-filter: blur(32px) saturate(190%); -webkit-backdrop-filter: blur(32px) saturate(190%); }
        .nav-pill-toggle { display: inline-flex; padding: 3px; border-radius: 999px;
            background: rgba(15, 23, 42, 0.96); border: 1px solid rgba(51, 65, 85, 0.9); }
        .segmented-item { border-radius: 999px; padding: 5px 11px; display: flex; align-items: center;
            gap: 6px; font-size: 11px; color: var(--text-muted); cursor: pointer;
            transition: background 0.18s, color 0.18s, transform 0.16s; }
        .segmented-item.active { background: linear-gradient(135deg, rgba(248, 113, 113, 0.35), rgba(251, 113, 133, 0.75)); color: #0f172a; }
        .segmented-dot { width: 4px; height: 4px; border-radius: 999px; background: currentColor; }
        .nav-icon-btn { width: 32px; height: 32px; border-radius: 999px; border: 1px solid rgba(51, 65, 85, 0.95);
            display: flex; align-items: center; justify-content: center; font-size: 16px; color: #e5e7eb;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
            cursor: pointer; transition: transform 0.16s, box-shadow 0.18s, background 0.18s; }
        .nav-icon-btn:active { transform: scale(0.9); box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9); }
        .nav-badge { position: absolute; top: -3px; right: -3px; min-width: 14px; height: 14px;
            border-radius: 999px; background: #f97316; color: #0f172a; font-size: 10px; display: flex;
            align-items: center; justify-content: center; font-weight: 600;
            box-shadow: 0 0 12px rgba(248, 113, 113, 0.95); }
        .nav-icon-wrapper { position: relative; }
        .hidden { display: none !important; }
        
        /* Setup & Profile Forms */
        .setup-container { padding: 20px; overflow-y: auto; max-height: 100%; }
        .setup-form { background: var(--glass); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .setup-title { text-align: center; font-size: 24px; margin-bottom: 20px; }
        .photo-upload { position: relative; width: 150px; height: 150px; margin: 0 auto 20px;
            border: 2px dashed rgba(148, 163, 184, 0.5); border-radius: 16px; display: flex;
            align-items: center; justify-content: center; cursor: pointer; background: rgba(15, 23, 42, 0.5);
            transition: all 0.3s; }
        .photo-upload:hover { border-color: var(--accent); background: rgba(15, 23, 42, 0.7); }
        .photo-upload img { max-width: 100%; max-height: 100%; border-radius: 14px; object-fit: cover; }
        .photo-upload input[type="file"] { display: none; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px; background: rgba(15, 23, 42, 0.6); color: var(--text); font-family: inherit; font-size: 16px; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag { padding: 8px 12px; border: 2px solid rgba(148, 163, 184, 0.3); border-radius: 20px;
            background: rgba(15, 23, 42, 0.6); color: var(--text); cursor: pointer;
            transition: all 0.2s; font-size: 13px; }
        .tag.selected { background: var(--accent); color: white; border-color: var(--accent); }
        .btn { padding: 12px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #ff8a80); color: white;
            box-shadow: 0 4px 12px rgba(255, 90, 95, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: rgba(15, 23, 42, 0.8); color: var(--text); border: 1px solid rgba(148, 163, 184, 0.3); margin-top: 8px; }
        .btn-danger { background: #ff3b30; color: white; margin-top: 12px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-emoji { font-size: 48px; margin-bottom: 12px; }
        
        /* Likes List */
        .likes-container { display: flex; flex-direction: column; gap: 12px; padding: 20px; overflow-y: auto; max-height: 100%; }
        .like-card { background: var(--glass); border-radius: 16px; padding: 12px; display: flex; gap: 12px;
            align-items: flex-start; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.5); }
        .like-card:active { transform: scale(0.98); }
        .like-photo { width: 80px; height: 80px; background: rgba(148, 163, 184, 0.2); border-radius: 12px;
            object-fit: cover; flex-shrink: 0; cursor: pointer; }
        .like-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .like-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .like-name { font-weight: 600; font-size: 16px; cursor: pointer; }
        .like-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 6px;
            font-size: 10px; font-weight: 600; }
        .like-location { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .like-actions { display: flex; gap: 8px; }
        .like-actions .btn { padding: 8px 12px; font-size: 13px; min-width: 50px; margin: 0; }
        .btn-small-primary { background: linear-gradient(135deg, var(--success), #81c784); color: white; }
        .btn-small-secondary { background: #ff6b6b; color: white; }
        
        /* Chat List */
        .chat-container { padding: 20px; overflow-y: auto; max-height: 100%; }
        .chat-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .chat-item { background: var(--glass); border-radius: 12px; padding: 12px; cursor: pointer;
            transition: all 0.2s; }
        .chat-item:active { background: rgba(15, 23, 42, 0.85); }
        .chat-header-item { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: white;
            display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 600; font-size: 14px; }
        .chat-preview { font-size: 12px; color: var(--text-muted); overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap; }
        
        /* Chat Detail */
        .chat-detail-container { display: flex; flex-direction: column; height: 100%; padding: 20px; }
        .chat-back-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text); margin-bottom: 16px; }
        .messages-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 8px 0; }
        .message { padding: 12px 16px; border-radius: 16px; max-width: 85%; word-wrap: break-word; }
        .message.own { align-self: flex-end; background: var(--accent); color: white; }
        .message.other { align-self: flex-start; background: var(--glass); color: var(--text); }
        .message-time { font-size: 11px; opacity: 0.7; margin-top: 4px; }
        .message-input-row { display: flex; gap: 8px; background: var(--glass); padding: 12px;
            border-radius: 12px; margin-top: 12px; }
        .message-input-row input { flex: 1; border: none; background: rgba(15, 23, 42, 0.6);
            color: var(--text); padding: 10px; border-radius: 8px; font-size: 14px; }
        .message-send-btn { background: var(--accent); color: white; border: none; border-radius: 8px;
            width: 44px; height: 44px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 18px; }
        
        /* Profile View */
        .profile-container { padding: 20px; overflow-y: auto; max-height: 100%; }
        .profile-card { background: var(--glass); border-radius: 20px; padding: 20px; }
        .profile-photo-section { text-align: center; margin-bottom: 20px; }
        .profile-photo-section img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
            margin-bottom: 16px; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.5); }
        .profile-photo-section h2 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .profile-photo-section p { color: var(--text-muted); margin: 4px 0 16px; }
        .profile-section-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .profile-bio { margin-bottom: 16px; line-height: 1.5; }
        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        .btn-group .btn { flex: 1; margin: 0; }
        
        @media (max-width: 400px) {
            .feed-frame { border-radius: 26px; }
            .circle-btn { width: 66px; height: 66px; }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <!-- Setup Section -->
    <div id="setup-section" class="screen-container hidden">
        <div class="setup-container">
            <div class="setup-form">
                <h2 class="setup-title">üòç –°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <img id="photoPreview" style="display: none;" />
                    <div id="photoPlaceholder" style="text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 4px;">üì∏</div>
                        <div style="font-size: 13px;">–ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</div>
                    </div>
                </div>
                <input type="file" id="photoInput" accept="image/*" />
                <div class="form-group"><label>‚úèÔ∏è –ò–º—è *</label><input type="text" id="setup-name" placeholder="–¢–≤–æ—ë –∏–º—è" /></div>
                <div class="form-group"><label>üéÇ –í–æ–∑—Ä–∞—Å—Ç *</label><input type="number" id="setup-age" placeholder="18+" min="18" /></div>
                <div class="form-group"><label>üìç –ì–æ—Ä–æ–¥ *</label><input type="text" id="setup-city" placeholder="–¢–≤–æ–π –≥–æ—Ä–æ–¥" /></div>
                <div class="form-group"><label>üí¨ –û —Å–µ–±–µ *</label><textarea id="setup-bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."></textarea></div>
                <div class="form-group"><label>üéØ –ò–Ω—Ç–µ—Ä–µ—Å—ã</label><div class="tags-container" id="setup-tags-container"></div></div>
                <button id="create-btn" class="btn btn-primary" onclick="saveProfile()">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="glass-panel">
        <div class="top-bar">
            <div class="top-title">
                <div class="top-logo"><span>üíó</span></div>
                <div>
                    <div class="top-text-main">LinLove</div>
                    <div class="top-text-sub">–∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –≤–Ω—É—Ç—Ä–∏ Telegram</div>
                </div>
            </div>
            <div class="pill-online"><div class="pill-dot"></div><span id="online-counter">‚Äî</span></div>
        </div>

        <div class="screen-container" id="main-screen">
            <!-- Feed Section -->
            <div id="feed-section" class="feed-frame">
                <div class="feed-photo-layer">
                    <img id="feed-photo" class="feed-photo" src="" alt="profile" />
                    <div class="feed-gradient-top"></div>
                    <div class="feed-gradient-bottom"></div>
                </div>
                <div class="feed-top-meta">
                    <div class="age-pill"><div class="age-dot"></div><span id="feed-age">‚Äî</span></div>
                </div>
                <div class="feed-main-meta">
                    <div class="name-row">
                        <div class="name-main" id="feed-name">‚Äî</div>
                        <div class="city-tag" id="feed-city"><span>üìç</span><span>‚Äî</span></div>
                    </div>
                    <div class="bio-text" id="feed-bio">‚Äî</div>
                    <div class="chips-row" id="feed-tags"></div>
                </div>
                <div class="actions-row">
                    <div class="swipe-hint"><span>–°–≤–∞–π–ø–∞–π ¬∑ –≤–ª–µ–≤–æ ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å ¬∑ –≤–ø—Ä–∞–≤–æ ‚Äî –ª–∞–π–∫</span></div>
                    <div class="actions-buttons">
                        <button class="circle-btn circle-dislike" id="btn-dislike">üëã</button>
                        <button class="circle-btn circle-like" id="btn-like">‚ô•</button>
                    </div>
                </div>
                <div id="no-profiles" class="empty-state hidden"></div>
            </div>
            
            <!-- Likes Section -->
            <div id="likes-section" class="hidden">
                <div class="likes-container" id="likes-container"></div>
                <div id="no-likes" class="empty-state hidden">
                    <div class="empty-state-emoji">üòî</div>
                    <div>–ö—Ç–æ-—Ç–æ —Ç–µ–±—è –ª–∞–π–∫–Ω—É–ª</div>
                    <div style="font-size: 12px; margin-top: 8px;">–û—Ç–≤–µ—Ç—å –ª–∞–π–∫–æ–º –∏ –Ω–∞–ø–∏—à–∏ –µ–º—É!</div>
                </div>
            </div>
            
            <!-- Messages Section -->
            <div id="messages-section" class="hidden">
                <div id="chat-list-view" class="chat-container">
                    <div class="chat-list" id="chat-list"></div>
                    <div id="no-chats" class="empty-state hidden">
                        <div class="empty-state-emoji">üì¨</div>
                        <div>–ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏</div>
                    </div>
                </div>
                <div id="chat-detail-view" class="chat-detail-container hidden">
                    <button class="chat-back-btn" onclick="backToChats()">‚Üê –ù–∞–∑–∞–¥</button>
                    <div class="messages-list" id="messages-list"></div>
                    <div class="message-input-row">
                        <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." />
                        <button class="message-send-btn" onclick="sendMessage()">‚úàÔ∏è</button>
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div id="profile-section" class="hidden">
                <div class="profile-container" id="profile-view-container"></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav-glass" id="bottom-nav">
        <div class="bottom-nav-inner">
            <div class="nav-pill-toggle" id="nav-toggle">
                <div class="segmented-item active" data-target="feed"><div class="segmented-dot"></div><span>–ê–Ω–∫–µ—Ç—ã</span></div>
                <div class="segmented-item" data-target="likes"><span>–õ–∞–π–∫–∏</span></div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="nav-icon-wrapper">
                    <button class="nav-icon-btn" id="btn-messages">üí¨</button>
                    <div class="nav-badge hidden" id="badge-messages">0</div>
                </div>
                <button class="nav-icon-btn" id="btn-profile">üë§</button>
            </div>
        </div>
    </div>
</div>

<script>
    let userData = null, allTags = [], selectedTags = [], allProfiles = [], allLikes = [], currentChat = null;
    let filters = { ageMin: 18, ageMax: 99, city: '' };
    let isEditing = false, isSaving = false;
    const API_BASE = window.location.origin + '/api';
    const tg = window.Telegram?.WebApp;

    if (tg) {
        tg.expand();
        tg.ready();
        tg.enableClosingConfirmation();
        tg.disableVerticalSwipes?.();
    }

    function haptic(type = 'medium') {
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(type);
    }

    async function init() {
        if (!tg?.initDataUnsafe?.user) return;
        const user = tg.initDataUnsafe.user;
        userData = { id: user.id };
        
        try {
            allTags = await fetch(`${API_BASE}/tags`).then(r => r.json()).catch(() => []);
        } catch (e) { console.error('Tags fetch error:', e); }
        renderSetupTags();
        
        try {
            const existing = await fetch(`${API_BASE}/user/${user.id}`).then(r => r.ok ? r.json() : null);
            if (existing?.name && existing?.age && existing?.city && existing?.bio) {
                userData = existing;
                document.getElementById('setup-section').classList.add('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                switchSection('feed');
                loadProfiles();
                loadLikes();
                loadChats();
            } else {
                document.getElementById('setup-section').classList.remove('hidden');
                document.getElementById('main-screen').style.display = 'none';
                document.getElementById('bottom-nav').classList.add('hidden');
            }
        } catch (e) { 
            console.error('User fetch error:', e);
            document.getElementById('setup-section').classList.remove('hidden');
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('bottom-nav').classList.add('hidden');
        }
    }

    function renderSetupTags() {
        const container = document.getElementById('setup-tags-container');
        container.innerHTML = allTags.map(tag => 
            `<div class="tag ${selectedTags.includes(tag.id) ? 'selected' : ''}" onclick="toggleTag(${tag.id})">${tag.emoji} ${tag.name}</div>`
        ).join('');
    }

    function toggleTag(tagId) {
        selectedTags = selectedTags.includes(tagId) ? selectedTags.filter(id => id !== tagId) : [...selectedTags, tagId];
        renderSetupTags();
    }

    async function saveProfile() {
        if (isSaving) return;
        isSaving = true;
        const btn = document.getElementById('create-btn');
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '‚ö° –ó–∞–≥—Ä—É–∑–∫–∞...';
        
        try {
            const name = document.getElementById('setup-name').value.trim();
            const age = document.getElementById('setup-age').value;
            const city = document.getElementById('setup-city').value.trim();
            const bio = document.getElementById('setup-bio').value.trim();
            
            if (!name || !age || !city || !bio) {
                alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            haptic('light');
            const photoFile = document.getElementById('photoInput').files[0];
            let photoUrl = userData?.photo_url || null;
            
            if (photoFile) {
                try {
                    const reader = new FileReader();
                    const photoData = await new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(photoFile);
                    });
                    
                    const uploadRes = await fetch(`${API_BASE}/upload-photo`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userData.id, photo_data: photoData })
                    }).then(r => r.json());
                    
                    if (uploadRes.photo_url) {
                        photoUrl = uploadRes.photo_url;
                    } else {
                        alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
                        return;
                    }
                } catch (e) {
                    console.error('Photo upload error:', e);
                    alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å —Ñ–æ—Ç–æ: ' + e.message);
                    return;
                }
            }
            
            const userRes = await fetch(`${API_BASE}/user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: userData.id, name, age: parseInt(age), city, bio, photo_url: photoUrl, tag_ids: selectedTags })
            }).then(r => r.json());
            
            if (userRes.error) {
                alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + userRes.error);
                return;
            }
            
            userData = { id: userData.id, name, age: parseInt(age), city, bio, photo_url: photoUrl, tags: [] };
            haptic('medium');
            
            if (!isEditing) {
                document.getElementById('setup-section').classList.add('hidden');
                document.getElementById('main-screen').style.display = 'flex';
                document.getElementById('bottom-nav').classList.remove('hidden');
                switchSection('feed');
                loadProfiles();
            } else {
                isEditing = false;
                switchSection('profile');
                showProfileView();
            }
        } catch (e) {
            console.error('Save profile error:', e);
            alert('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + e.message);
        } finally {
            isSaving = false;
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    async function loadProfiles() {
        try {
            const params = new URLSearchParams({ age_min: filters.ageMin, age_max: filters.ageMax, city: filters.city });
            allProfiles = await fetch(`${API_BASE}/profiles/${userData.id}?${params}`).then(r => r.json()).catch(() => []);
            renderCards();
        } catch (e) { console.error('Load profiles error:', e); }
    }

    function renderCards() {
        const noProfiles = document.getElementById('no-profiles');
        if (!allProfiles.length) {
            noProfiles.innerHTML = `<div class="empty-state-emoji">üåü</div><div>–ü—Ä–æ—Ñ–∏–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div><div style="font-size: 12px; margin-top: 8px;">–¢—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª –≤—Å–µ—Ö. –ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã!</div>`;
            noProfiles.classList.remove('hidden');
            document.getElementById('feed-photo').src = '';
            document.getElementById('feed-name').textContent = '‚Äî';
            document.getElementById('feed-age').textContent = '‚Äî';
            document.getElementById('feed-city').querySelector('span:last-child').textContent = '‚Äî';
            document.getElementById('feed-bio').textContent = '‚Äî';
            document.getElementById('feed-tags').innerHTML = '';
            return;
        }
        noProfiles.classList.add('hidden');
        const profile = allProfiles[0];
        document.getElementById('feed-photo').src = profile.photo_url || '';
        document.getElementById('feed-name').textContent = profile.name;
        document.getElementById('feed-age').textContent = profile.age;
        document.getElementById('feed-city').querySelector('span:last-child').textContent = profile.city;
        document.getElementById('feed-bio').textContent = profile.bio;
        const tagsContainer = document.getElementById('feed-tags');
        tagsContainer.innerHTML = '';
        (profile.tags || []).forEach((t, i) => {
            const div = document.createElement('div');
            div.className = 'chip' + (i === 0 ? ' chip-accent' : '');
            div.textContent = `${t.emoji} ${t.name}`;
            tagsContainer.appendChild(div);
        });
    }

    async function handleSwipe(toUserId, isLike) {
        haptic('medium');
        try {
            const res = await fetch(`${API_BASE}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_user: userData.id, to_user: toUserId })
            }).then(r => r.json());
            if (res.match) { haptic('heavy'); loadChats(); }
        } catch (e) { console.error('Like error:', e); }
        allProfiles = allProfiles.filter(p => p.id !== toUserId);
        renderCards();
    }

    document.getElementById('btn-like').addEventListener('click', () => {
        if (allProfiles.length) handleSwipe(allProfiles[0].id, true);
    });

    document.getElementById('btn-dislike').addEventListener('click', () => {
        if (allProfiles.length) handleSwipe(allProfiles[0].id, false);
    });

    const feed = document.getElementById('feed-section');
    let startX = 0, currentX = 0, isDragging = false;
    const swipeThreshold = 60;

    function handleStart(x) {
        if (!allProfiles.length) return;
        isDragging = true;
        startX = x;
        currentX = x;
        feed.style.transition = 'none';
    }

    function handleMove(x) {
        if (!isDragging) return;
        currentX = x;
        const delta = currentX - startX;
        const rotation = delta * 0.03;
        const opacity = 1 - Math.min(Math.abs(delta) / 260, 0.6);
        feed.style.transform = `translateX(${delta}px) rotate(${rotation}deg)`;
        feed.style.opacity = opacity;
    }

    function handleEnd() {
        if (!isDragging) return;
        isDragging = false;
        const delta = currentX - startX;
        if (Math.abs(delta) > swipeThreshold) {
            haptic('light');
            const direction = delta > 0 ? 1 : -1;
            feed.style.transition = 'transform 0.22s ease-out, opacity 0.22s ease-out';
            feed.style.transform = `translateX(${direction * 420}px) rotate(${direction * 14}deg)`;
            feed.style.opacity = 0;
            setTimeout(() => {
                feed.style.transition = 'none';
                feed.style.transform = 'translateX(0) rotate(0)';
                feed.style.opacity = 1;
                if (allProfiles.length) handleSwipe(allProfiles[0].id, delta > 0);
            }, 220);
        } else {
            feed.style.transition = 'transform 0.2s ease-out, opacity 0.2s ease-out';
            feed.style.transform = 'translateX(0) rotate(0)';
            feed.style.opacity = 1;
        }
    }

    feed.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientX));
    feed.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientX));
    feed.addEventListener('touchend', handleEnd);
    feed.addEventListener('mousedown', (e) => handleStart(e.clientX));
    window.addEventListener('mousemove', (e) => handleMove(e.clientX));
    window.addEventListener('mouseup', handleEnd);

    async function loadLikes() {
        try {
            allLikes = await fetch(`${API_BASE}/likes/${userData.id}`).then(r => r.json()).catch(() => []);
            renderLikes();
        } catch (e) { console.error('Load likes error:', e); }
    }

    function renderLikes() {
        const container = document.getElementById('likes-container'), noLikes = document.getElementById('no-likes');
        if (!allLikes.length) {
            container.innerHTML = '';
            noLikes.classList.remove('hidden');
            document.getElementById('badge-messages').classList.add('hidden');
        } else {
            noLikes.classList.add('hidden');
            document.getElementById('badge-messages').textContent = allLikes.length;
            document.getElementById('badge-messages').classList.remove('hidden');
            container.innerHTML = allLikes.map(like => `
                <div class="like-card">
                    <img src="${like.photo_url || ''}" class="like-photo" />
                    <div class="like-info">
                        <div class="like-header">
                            <div class="like-name">${like.name}, ${like.age}</div>
                            <div class="like-badge">‚ù§Ô∏è</div>
                        </div>
                        <div class="like-location">üìç ${like.city}</div>
                        <div class="like-actions">
                            <button class="btn btn-small-primary" onclick="likeUser(${like.id})">‚ù§Ô∏è</button>
                            <button class="btn btn-small-secondary" onclick="dislikeUser(${like.id})">üëã</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    async function likeUser(userId) {
        haptic('light');
        try {
            await fetch(`${API_BASE}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_user: userData.id, to_user: userId })
            }).then(r => r.json());
        } catch (e) { console.error('Like error:', e); return; }
        allLikes = allLikes.filter(l => l.id !== userId);
        renderLikes();
        await new Promise(r => setTimeout(r, 300));
        loadChats();
        switchSection('messages');
    }

    async function dislikeUser(userId) {
        haptic('light');
        try {
            await fetch(`${API_BASE}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_user: userData.id, to_user: userId, dislike: true })
            }).then(r => r.json());
        } catch (e) { console.error('Dislike error:', e); return; }
        allLikes = allLikes.filter(l => l.id !== userId);
        renderLikes();
    }

    async function loadChats() {
        try {
            const chats = await fetch(`${API_BASE}/chats/${userData.id}`).then(r => r.json()).catch(() => []);
            const chatList = document.getElementById('chat-list'), noChats = document.getElementById('no-chats');
            if (!chats.length) {
                chatList.innerHTML = '';
                noChats.classList.remove('hidden');
            } else {
                noChats.classList.add('hidden');
                chatList.innerHTML = chats.map(chat => `
                    <div class="chat-item" onclick="openChat(${chat.user_id}, '${chat.user_name}', '${chat.user_photo || ''}')">
                        <div class="chat-header-item">
                            <div class="chat-avatar">${chat.user_name.charAt(0).toUpperCase()}</div>
                            <div class="chat-info">
                                <div class="chat-name">${chat.user_name}</div>
                                <div class="chat-preview">${chat.last_message || '–ù–∞—á–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä...'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } catch (e) { console.error('Load chats error:', e); }
    }

    function openChat(userId, userName, userPhoto) {
        currentChat = { userId, userName, userPhoto };
        document.getElementById('chat-list-view').classList.add('hidden');
        document.getElementById('chat-detail-view').classList.remove('hidden');
        loadMessages();
    }

    function backToChats() {
        currentChat = null;
        document.getElementById('chat-list-view').classList.remove('hidden');
        document.getElementById('chat-detail-view').classList.add('hidden');
    }

    async function loadMessages() {
        if (!currentChat) return;
        try {
            const messages = await fetch(`${API_BASE}/messages/${currentChat.userId}/${userData.id}`).then(r => r.json()).catch(() => []);
            const msgList = document.getElementById('messages-list');
            msgList.innerHTML = messages.map(msg => `
                <div class="message ${msg.from_user === userData.id ? 'own' : 'other'}">
                    <div>${msg.text}</div>
                    <div class="message-time">${new Date(msg.created_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `).join('');
            msgList.scrollTop = msgList.scrollHeight;
        } catch (e) { console.error('Load messages error:', e); }
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text || !currentChat) return;
        try {
            await fetch(`${API_BASE}/message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_user: userData.id, to_user: currentChat.userId, text })
            }).then(r => r.json());
        } catch (e) { console.error('Send message error:', e); return; }
        input.value = '';
        loadMessages();
        haptic('light');
    }

    function editProfile() {
        isEditing = true;
        selectedTags = userData.tags?.map(t => t.id) || [];
        document.getElementById('setup-name').value = userData.name || '';
        document.getElementById('setup-age').value = userData.age || '';
        document.getElementById('setup-city').value = userData.city || '';
        document.getElementById('setup-bio').value = userData.bio || '';
        if (userData.photo_url) {
            document.getElementById('photoPreview').src = userData.photo_url;
            document.getElementById('photoPreview').style.display = 'block';
            document.getElementById('photoPlaceholder').style.display = 'none';
        }
        renderSetupTags();
        document.getElementById('setup-section').classList.remove('hidden');
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('bottom-nav').classList.add('hidden');
    }

    async function deleteProfile() {
        if (!confirm('‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ! –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
        if (!confirm('‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å?')) return;
        haptic('heavy');
        try {
            const res = await fetch(`${API_BASE}/user/${userData.id}`, { method: 'DELETE' });
            if (!res.ok) {
                alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }
        } catch (e) { console.error('Delete error:', e); alert('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + e.message); return; }
        
        userData = null;
        selectedTags = [];
        allProfiles = [];
        allLikes = [];
        currentChat = null;
        
        document.getElementById('setup-name').value = '';
        document.getElementById('setup-age').value = '';
        document.getElementById('setup-city').value = '';
        document.getElementById('setup-bio').value = '';
        document.getElementById('photoInput').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('photoPlaceholder').style.display = 'block';
        
        document.getElementById('setup-section').classList.remove('hidden');
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('bottom-nav').classList.add('hidden');
        
        haptic('medium');
        alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª–µ–Ω. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π!');
    }

    function switchSection(section) {
        document.querySelectorAll('#main-screen > div').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.segmented-item').forEach(b => b.classList.remove('active'));
        
        if (section === 'feed') {
            document.getElementById('feed-section').classList.remove('hidden');
            document.querySelectorAll('.segmented-item')[0].classList.add('active');
            loadProfiles();
        } else if (section === 'likes') {
            document.getElementById('likes-section').classList.remove('hidden');
            document.querySelectorAll('.segmented-item')[1].classList.add('active');
            loadLikes();
        } else if (section === 'messages') {
            document.getElementById('messages-section').classList.remove('hidden');
            backToChats();
            loadChats();
        } else if (section === 'profile') {
            document.getElementById('profile-section').classList.remove('hidden');
            showProfileView();
        }
    }

    function showProfileView() {
        const container = document.getElementById('profile-view-container');
        container.innerHTML = `
            <div class="profile-card">
                <div class="profile-photo-section">
                    ${userData.photo_url ? `<img src="${userData.photo_url}" />` : ''}
                    <h2>${userData.name}, ${userData.age}</h2>
                    <p>üìç ${userData.city}</p>
                </div>
                <div class="profile-bio">
                    <div class="profile-section-title">üí¨ –û –º–Ω–µ</div>
                    <p>${userData.bio}</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="editProfile()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <button class="btn btn-danger" onclick="deleteProfile()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>
        `;
    }

    document.getElementById('photoInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const preview = document.getElementById('photoPreview');
                preview.src = event.target.result;
                preview.style.display = 'block';
                document.getElementById('photoPlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('nav-toggle').querySelectorAll('.segmented-item').forEach((item, idx) => {
        item.addEventListener('click', () => {
            haptic('light');
            switchSection(idx === 0 ? 'feed' : 'likes');
        });
    });

    document.getElementById('btn-messages').addEventListener('click', () => {
        haptic('light');
        switchSection('messages');
    });

    document.getElementById('btn-profile').addEventListener('click', () => {
        haptic('light');
        switchSection('profile');
    });

    init();
</script>
</body>
</html>